name: Build & Release

on:
  push:
    tags:
      - v*

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  build-and-release-ios-ipa:
    permissions:
      contents: write
    runs-on: macos-latest
    steps:
      - name: Checkout branch
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install the CLI tool
        run: cargo install 'flutter_rust_bridge_codegen'

      - name: Flutter pub get
        run: flutter pub get

      - name: Setup keychain and import certificate
        env:
          CODESIGN_PASSWORD: ${{ secrets.CODESIGN_PASSWORD }}
          KEYCHAIN_PATH: build.keychain
          CERTIFICATE_ID: ${{ secrets.CERTIFICATE_ID }}
          PROFILE_ID: ${{ secrets.PROFILE_ID }}
          CERTIFICATE_FILE_B64: ${{ secrets.CERTIFICATE_FILE_B64 }}
        run: |
          echo "$CERTIFICATE_FILE_B64" | base64 --decode > certificate.p12
          echo "$MOBILEPROVISION_FILE_B64" | base64 --decode > profile.mobileprovision

          security create-keychain -p "$CODESIGN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "$CODESIGN_PASSWORD"
          security import certificate.p12 -t agg -k "$KEYCHAIN_PATH" -P "$CODESIGN_PASSWORD" -A
          security set-key-partition-list -S "apple-tool:,apple:,codesign" -s -k "$CODESIGN_PASSWORD" "$KEYCHAIN_PATH"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          mv profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${PROFILE_ID}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      - name: Build iOS IPA
        run: |
          flutter build ipa --release --no-codesign
          cd build/ios/iphoneos

          security unlock-keychain -p "$CODESIGN_PASSWORD" "$KEYCHAIN_PATH"

          CERTIFICATE_ID=$(security find-identity -p codesigning -v | grep 'Apple' | awk '{print $2}' | head -n 1)
          echo "Using CERTIFICATE_ID: $CERTIFICATE_ID"

          codesign --deep --force --options runtime -vvv --sign "$CERTIFICATE_ID" ../archive/Runner.xcarchive/Products/Applications/Runner.app

          mkdir Payload
          mv Runner.app Payload/
          zip -r app-release.ipa Payload
          mv app-release.ipa Mangayomi-${{ github.ref_name }}-ios.ipa
  

      - name: Upload Artifact iOS IPA
        uses: actions/upload-artifact@v4
        with:
          name: Mangayomi-${{ github.ref_name }}-ios
          path: "build/ios/iphoneos/Mangayomi-*.ipa"

      - name: Release Package iOS IPA
        uses: ncipollo/release-action@v1
        with:
          artifacts: "build/ios/iphoneos/Mangayomi-*.ipa"
          allowUpdates: true


  call-workflow-sideloading:
    needs: build-and-release-ios-ipa
    uses: ./.github/workflows/update_sideloading_source.yml